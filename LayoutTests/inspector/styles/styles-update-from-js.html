<html>
<head>
<script src="../../http/tests/inspector/inspector-test.js"></script>
<script src="../../http/tests/inspector/elements-test.js"></script>
<script>
function modifyStyleAttribute()
{
    document.getElementById("container").setAttribute("style", "color: #daC0DE; border: 1px solid black;");
}

function modifyCSSText()
{
    document.getElementById("container").style.cssText = "color: #C0FFEE";
}

function modifyParsedAttributes()
{
    var style = document.getElementById("container").style;
    style.border = "2px dashed green";
    style.borderWidth = "3px";
}

function test()
{
    var sniffCount = 0;
    var inlineStyleInvalidationCount = 0;

    InspectorTest.selectNodeWithId("container");
    InspectorTest.addSniffer(WebInspector.StylesSidebarPane.prototype, "_rebuildUpdate", snifferCallback, true);
    InspectorTest.addSniffer(WebInspector.DOMDispatcher.prototype, "inlineStyleInvalidated", inlineStyleInvalidatedSniffer, true);

    function inlineStyleInvalidatedSniffer()
    {
        inlineStyleInvalidationCount += 1;
    }

    function snifferCallback()
    {
        function innerCallback()
        {
            switch (sniffCount++) {
                case 0:
                    InspectorTest.evaluateInPage("modifyStyleAttribute()");
                    break;
                case 1:
                    InspectorTest.addResult("Modified \"style\" attribute");
                    dumpAttributeAndStyles();
                    InspectorTest.evaluateInPage("modifyCSSText()");
                    break;
                case 2:
                    InspectorTest.addResult("Modified cssText");
                    dumpAttributeAndStyles();
                    InspectorTest.evaluateInPage("modifyParsedAttributes()");
                    break;
                case 3:
                    InspectorTest.addResult("Modified parsed attributes");
                    dumpAttributeAndStyles();
                    InspectorTest.addResult("Inline style invalidated " + inlineStyleInvalidationCount + " times");
                    InspectorTest.completeTest();
                    break;
            }
        }

        InspectorTest.runAfterPendingDispatches(innerCallback);
    }

    function dumpAttributeAndStyles()
    {
        var treeElement = findNodeTreeElement()
        if (!treeElement) {
            InspectorTest.addResult("'container' tree element not found");
            return;
        }
        InspectorTest.addResult(treeElement.listItemElement.textContent.replace(/\u200b/g, ""));
        InspectorTest.dumpSelectedElementStyles(true, true);
    }

    function findNodeTreeElement()
    {
        WebInspector.panels.elements.updateModifiedNodes();
        var expandedNode = InspectorTest.expandedNodeWithId("container");
        if (!expandedNode) {
            InspectorTest.addResult("'container' node not found");
            InspectorTest.completeTest();
        }
        return WebInspector.panels.elements.treeOutline.findTreeElement(expandedNode);
    }
}
</script>
</head>

<body onload="runTest()">
<p>
Tests that changes to an inline style from JavaScript are reflected in the Styles pane and Elements tree.
</p>

<div id="container" style="font-weight:bold">
</div>

</body>
</html>
