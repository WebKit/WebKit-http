<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="../js/resources/js-test-style.css">
<script src="../js/resources/js-test-pre.js"></script>
<title></title>
</head>
<body>
<p id=description></p>
<div id="console"></div>
<script>

window.jsTestIsAsync = true;
var mutations;
var mutations2;
var div;
var subDiv;
var calls;

function testBasic() {
    var observer;

    function start() {
        debug('Testing basic aspects of subtree observation.');

        mutations = null;
        div = document.createElement('div');
        subDiv = div.appendChild(document.createElement('div'));
        subDiv.innerHTML = 'hello, world';
        observer = new WebKitMutationObserver(function(mutations) {
            window.mutations = mutations;
        });

        observer.observe(div, {attributes: true, characterData: true, subtree: true});
        subDiv.setAttribute('foo', 'bar');
        subDiv.firstChild.textContent = 'goodbye!';
        setTimeout(finish, 0);
    }

    function finish() {
        debug('...attribute and characterData changes in subtree');

        shouldBe('mutations.length', '2');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].target', 'subDiv');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[0].attributeNamespace', 'null');
        shouldBe('mutations[1].type', '"characterData"');
        shouldBe('mutations[1].target', 'subDiv.firstChild');
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testMultipleObservers() {
    var observer;
    var observer2;

    function start() {
        debug('Testing two observers at different depths.');

        mutations = null;
        mutations2 = null;
        div = document.createElement('div');
        subDiv = div.appendChild(document.createElement('div'));
        observer = new WebKitMutationObserver(function(mutations) {
            window.mutations = mutations;
        });
        observer2 = new WebKitMutationObserver(function(mutations) {
            window.mutations2 = mutations;
        });

        observer.observe(div, {attributes: true, subtree: true});
        observer2.observe(subDiv, {attributes: true});
        subDiv.setAttribute('foo', 'bar');
        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutations.length', '1');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].target', 'subDiv');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[0].attributeNamespace', 'null');
        shouldBe('mutations2.length', '1');
        shouldBe('mutations2[0].type', '"attributes"');
        shouldBe('mutations2[0].target', 'subDiv');
        shouldBe('mutations2[0].attributeName', '"foo"');
        shouldBe('mutations2[0].attributeNamespace', 'null');
        observer.disconnect();
        observer2.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testMultipleObservations() {
    var observer;

    function start() {
        debug('Testing one observer at two different depths.');

        mutations = null;
        calls = 0;
        div = document.createElement('div');
        subDiv = div.appendChild(document.createElement('div'));
        observer = new WebKitMutationObserver(function(mutations) {
            window.mutations = mutations;
            ++calls;
        });

        observer.observe(div, {attributes: true, subtree: true});
        observer.observe(subDiv, {attributes: true, subtree: true});
        subDiv.setAttribute('foo', 'bar');
        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('calls', '1');
        shouldBe('mutations.length', '1');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].target', 'subDiv');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[0].attributeNamespace', 'null');
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}
var tests = [testBasic, testMultipleObservers, testMultipleObservations];
var testIndex = 0;

function runNextTest() {
    if (testIndex < tests.length)
        tests[testIndex++]();
    else
        finishJSTest();
}

description('Test WebKitMutationObserver.observe on a subtree');

if (!window.WebKitMutationObserver)
    testFailed('This test requires ENABLE(MUTATION_OBSERVERS)');
else
    runNextTest();

var successfullyParsed = true;

</script>
<script src="../js/resources/js-test-post.js"></script>
</body>
</html>
