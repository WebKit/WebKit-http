<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="../js/resources/js-test-pre.js"></script>
</head>
<body>
<p id=description></p>
<div id="console"></div>
<script>

window.jsTestIsAsync = true;
var mutations, mutations2, mutationsWithOldValue;
var calls;

function testBasic() {
    var div;
    var observer;

    function start() {
        debug('Testing basic aspects of attribute observation.');

        mutations = null;
        div = document.createElement('div');
        observer = new WebKitMutationObserver(function(m) {
            mutations = m;
        });

        observer.observe(div, { attributes: true, characterData: true });
        div.setAttribute('foo', 'bar');
        setTimeout(checkDisconnectAndMutate, 0);
    }

    function checkDisconnectAndMutate() {
        debug('...can attribute changes be observed at all');

        shouldBe('mutations.length', '1');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[0].attributeNamespace', 'null');

        mutations = null;
        observer.disconnect();
        div.setAttribute('foo', 'baz');
        setTimeout(checkNotDeliveredAndMutateMultiple, 0);
    }

    function checkNotDeliveredAndMutateMultiple() {
        debug('...observer.disconnect() should prevent further delivery of mutations.');

        shouldBe('mutations', 'null');
        observer.observe(div, { attributes: true });
        div.setAttribute('foo', 'bat');
        div.setAttribute('bar', 'foo');
        setTimeout(finish);
    }

    function finish() {
        debug('...re-observing after disconnect works with the same observer.');

        shouldBe('mutations.length', '2');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[0].attributeNamespace', 'null');
        shouldBe('mutations[1].type', '"attributes"');
        shouldBe('mutations[1].attributeName', '"bar"');
        shouldBe('mutations[1].attributeNamespace', 'null');
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testWrongType() {
    var div;
    var observer;

    function start() {
        debug('Testing that observing without specifying "attributes" does not result in hearing about attribute changes.');

        mutations = null;
        div = document.createElement('div');
        observer = new WebKitMutationObserver(function(m) {
            mutations = m;
        });

        observer.observe(div, { childList: true, characterData: true });
        div.setAttribute('foo', 'bar');
        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutations', 'null');
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testMultipleRegistration() {
    var div;
    var observer;

    function start() {
        debug('Testing that re-observing the same node with the same observer has the effect of resetting the options.');
    
		calls = 0;
        mutations = null;
        div = document.createElement('div');
        observer = new WebKitMutationObserver(function(m) {
            mutations = m;
			calls++;
        });

        observer.observe(div, { attributes: true, characterData: true });
        observer.observe(div, { attributes: true });
        div.setAttribute('foo', 'bar');
        setTimeout(checkDisconnectAndMutate, 0);
    }

    function checkDisconnectAndMutate() {
        shouldBe('calls', '1');
        shouldBe('mutations.length', '1');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"foo"');
        mutations = null;
        observer.observe(div, { attributes: true, characterData: true });
        observer.observe(div, { childList: true });
        div.setAttribute('foo', 'baz');
        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutations', 'null');
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testMultipleObservers() {
    var div;
    var observer;
    var observer2;

    function start() {
        debug('Testing that multiple observers can be registered to a given node and both receive mutations.');
        mutations = null;
        div = document.createElement('div');
        observer = new WebKitMutationObserver(function(m) {
            mutations = m;
        });
        observer2 = new WebKitMutationObserver(function(m) {
            mutations2 = m;
        });
        observer.observe(div, { attributes: true });
        observer2.observe(div, { attributes: true });
        div.setAttribute('foo', 'bar');
        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutations.length', '1');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations2.length', '1');
        shouldBe('mutations2[0].type', '"attributes"');
        shouldBe('mutations2[0].attributeName', '"foo"');
        observer.disconnect();
        observer2.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testNamespaceURI() {
    var div;
    var observer;

    function start() {
        debug('Testing that "attributeNamespace" value is delivered properly.');
        mutations = null;
        div = document.createElement('div');
        observer = new WebKitMutationObserver(function(m) {
            mutations = m;
        });

        observer.observe(div, { attributes: true, childList: true });
        div.setAttributeNS('http://www.foo.com/bar', 'foo', 'bar');
        setTimeout(finish, 0);    
    }

    function finish() {
        shouldBe('mutations.length', '1');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[0].attributeNamespace', '"http://www.foo.com/bar"');        
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testPropertyAccess() {
    var img, a;
    var observer;

    function start() {
        debug('Testing that modifications to node properties which delegate to attribute storage deliver mutations.');
        mutations = null;
        img = document.createElement('img');
        a = document.createElement('a');

        observer = new WebKitMutationObserver(function(m) {
            mutations = m;
        });

        observer.observe(img, { attributes: true });
        observer.observe(a, { attributes: true });

        img.src = 'baz.png';
        a.href = 'foo.html';

        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutations.length', '2');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"src"');
        shouldBe('mutations[1].type', '"attributes"');
        shouldBe('mutations[1].attributeName', '"href"');
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testOrderingWrtDOMSubtreeModified() {
    var div, div2, subDiv;
    var observer;
    var listener;

    function start() {
        debug('Testing mutation records are enqueued for attributes before DOMSubtreeModified is dispatched.');

        mutations = null;
        div = document.body.appendChild(document.createElement('div'));
        div2 = document.body.appendChild(document.createElement('div'));

        subDiv = div.appendChild(document.createElement('div'));

        observer = new WebKitMutationObserver(function(m) {
            mutations = m;
        });

        listener = function(e) {
            div2.setAttribute('baz', 'bat');
        }

        div.addEventListener('DOMSubtreeModified', listener);
        observer.observe(subDiv, { attributes: true });
        observer.observe(div2, { attributes: true });

        subDiv.setAttribute('foo', 'bar');

        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutations.length', '2');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[1].type', '"attributes"');
        shouldBe('mutations[1].attributeName', '"baz"');
        div.removeEventListener(listener);
        document.body.removeChild(div);
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testOldValue() {
    var div;
    var observer;

    function start() {
        debug('Testing basic oldValue delivery.');
        mutations = null;
        div = document.createElement('div');
        observer = new WebKitMutationObserver(function(mutations) {
            window.mutations = mutations;
        });
        observer.observe(div, { attributes: true, attributeOldValue: true });
        div.setAttribute('foo', 'bar');
        div.setAttribute('foo', 'baz');
        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutations.length', '2');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[0].oldValue', 'null');
        shouldBe('mutations[1].type', '"attributes"');
        shouldBe('mutations[1].attributeName', '"foo"');
        shouldBe('mutations[1].oldValue', '"bar"');
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testOldValueAsRequested() {
    var div;
    var observerWithOldValue;
    var observer;

    function start() {
        debug('Testing that oldValue is delivered as requested (or not).');
        mutationsWithOldValue = null;
        mutations = null;
        div = document.createElement('div');
        div.setAttribute('foo', 'bar');
        observerWithOldValue = new WebKitMutationObserver(function(mutations) {
            window.mutationsWithOldValue = mutations;
        });
        observer = new WebKitMutationObserver(function(mutations) {
            window.mutations = mutations;
        });
        observerWithOldValue.observe(div, { attributes: true, attributeOldValue: true });
        observer.observe(div, { attributes: true });
        div.setAttribute('foo', 'baz');
        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutationsWithOldValue.length', '1');
        shouldBe('mutationsWithOldValue[0].type', '"attributes"');
        shouldBe('mutationsWithOldValue[0].attributeName', '"foo"');
        shouldBe('mutationsWithOldValue[0].oldValue', '"bar"');
        shouldBe('mutations.length', '1');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[0].oldValue', 'null');
        observerWithOldValue.disconnect();
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testOldValueUnionMultipleObservations() {
    var div;
    var span;
    var observer;

    function start() {
        debug('An observer with multiple observations will get attributeOldValue if any entries request it.');
        mutations = null;
        div = document.createElement('div');
        span = div.appendChild(document.createElement('span'));
        span.setAttribute('foo', 'bar');
        observer = new WebKitMutationObserver(function(mutations) {
            window.mutations = mutations;
        });
        observer.observe(div, { attributes: true, attributeOldValue: true, subtree: true });
        observer.observe(span, { attributes: true });
        span.setAttribute('foo', 'baz');
        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutations.length', '1');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"foo"');
        shouldBe('mutations[0].oldValue', '"bar"');
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

function testIDLAttribute() {
    var div;
    var observer;

    function start() {
        debug('Testing setting an attribute via reflected IDL attribute.');
        mutations = null;
        div = document.createElement('div');
        observer = new WebKitMutationObserver(function(mutations) {
            window.mutations = mutations;
        });
        observer.observe(div, { attributes: true, attributeOldValue: true });
        div.id = 'foo';
        div.id = 'bar';
        setTimeout(finish, 0);
    }

    function finish() {
        shouldBe('mutations.length', '2');
        shouldBe('mutations[0].type', '"attributes"');
        shouldBe('mutations[0].attributeName', '"id"');
        shouldBe('mutations[0].oldValue', 'null');
        shouldBe('mutations[1].type', '"attributes"');
        shouldBe('mutations[1].attributeName', '"id"');
        shouldBe('mutations[1].oldValue', '"foo"');
        observer.disconnect();
        debug('');
        runNextTest();
    }

    start();
}

var tests = [
    testBasic,
    testWrongType,
    testMultipleRegistration,
    testMultipleObservers,
    testNamespaceURI,
    testPropertyAccess,
    testOrderingWrtDOMSubtreeModified,
    testOldValue,
    testOldValueAsRequested,
    testOldValueUnionMultipleObservations,
    testIDLAttribute
];
var testIndex = 0;

function runNextTest() {
    if (testIndex < tests.length)
        tests[testIndex++]();
    else
        finishJSTest();
}

description('Test WebKitMutationObserver.observe on attributes');

if (!window.WebKitMutationObserver)
    testFailed('This test requires ENABLE(MUTATION_OBSERVERS)');
else
    runNextTest();

</script>
<script src="../js/resources/js-test-post.js"></script>
</body>
</html>
