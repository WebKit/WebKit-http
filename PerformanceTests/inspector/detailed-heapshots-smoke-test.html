<html>
<head>
  <script src="../../LayoutTests/http/tests/inspector/inspector-test.js"></script>
  <script src="../../LayoutTests/inspector/profiler/detailed-heapshots-test.js"></script>
  <script src="performance-test.js"></script>
<script>

function test()
{
    function performanceTest(timer)
    {

        var transferTimerCookie;
        var showTimerCookie;
        var changeViewTimerCookie;
        var clearTimerCookie;

        var allTimerCookie = timer.start("summary-snapshot-time");
        var backendTimerCookie = timer.start("take-snapshot");
        ProfilerAgent.takeHeapSnapshot(step0);

        function step0()
        {
            timer.finish(backendTimerCookie);
            transferTimerCookie = timer.start("transfer-snapshot");
            var profiles = WebInspector.panels.profiles.getProfiles("HEAP");
            WebInspector.panels.profiles.showProfile(profiles[profiles.length - 1]);
            InspectorTest.addSniffer(WebInspector.panels.profiles, "_finishHeapSnapshot", step1);
        }

        function step1(uid)
        {
            timer.finish(transferTimerCookie);
            showTimerCookie = timer.start("show-snapshot");
            var panel = WebInspector.panels.profiles;
            var profile = panel._profilesIdMap[panel._makeKey(uid, WebInspector.DetailedHeapshotProfileType.TypeId)];
            InspectorTest.addSniffer(profile.proxy, "_callLoadCallbacks", step2);
        }

        function step2()
        {
            timer.finish(showTimerCookie);
            timer.finish(allTimerCookie);
            changeViewTimerCookie = timer.start("switch-to-containment-view");
            InspectorTest.switchToView("Containment", cleanup);
        }

        function cleanup()
        {
            timer.finish(changeViewTimerCookie);
            clearTimerCookie = timer.start("clear-snapshot");
            ProfilerAgent.clearProfiles(done);
            WebInspector.panels.profiles._reset();
        }

        function done()
        {
            timer.finish(clearTimerCookie);
            timer.done("panel-update");
        }
    }

    InspectorTest.runPerformanceTest(performanceTest, 25000);
}

</script>
</head>
<body onload="runTest()">
</body>
</html>
