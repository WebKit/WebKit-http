<html>
<head>
  <script src="../../LayoutTests/http/tests/inspector/inspector-test.js"></script>
  <script src="../../LayoutTests/inspector/profiler/detailed-heapshots-test.js"></script>
  <script src="performance-test.js"></script>
<script>

function test()
{
    function performanceTest(timer)
    {

        var showPanelTimerCookie = timer.start("panel-update");
        ProfilerAgent.takeHeapSnapshot(step0);

        function step0()
        {
            var profiles = WebInspector.panels.profiles.getProfiles("HEAP");
            WebInspector.panels.profiles.showProfile(profiles[profiles.length - 1]);
            InspectorTest.addSniffer(WebInspector.panels.profiles, "_finishHeapSnapshot", step1);
        }

        function step1(uid)
        {
            var panel = WebInspector.panels.profiles;
            var profile = panel._profilesIdMap[panel._makeKey(uid, WebInspector.DetailedHeapshotProfileType.TypeId)];
            InspectorTest.addSniffer(profile.proxy, "_callLoadCallbacks", step2);
        }

        function step2()
        {
            InspectorTest.switchToView("Containment", cleanup);
        }

        function cleanup()
        {
            timer.finish(showPanelTimerCookie);
            ProfilerAgent.clearProfiles(done);
            WebInspector.panels.profiles._reset();
        }

        function done()
        {
            timer.done("take-snapshot");
        }
    }

    InspectorTest.runPerformanceTest(performanceTest, 25000);
}

</script>
</head>
<body onload="runTest()">
</body>
</html>
