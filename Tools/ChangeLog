2012-10-03  Benjamin Poulain  <bpoulain@apple.com>

        [WK2] Support all attributes of GeolocationPosition
        https://bugs.webkit.org/show_bug.cgi?id=98212

        Reviewed by Sam Weinig.

        Expand WebKitTestRunner and DumpRenderTree to test all the attributes
        of GeolocationPosition.

        * DumpRenderTree/TestRunner.cpp:
        (setMockGeolocationPositionCallback):
        * DumpRenderTree/TestRunner.h:
        (TestRunner):
        * DumpRenderTree/efl/TestRunnerEfl.cpp:
        (TestRunner::setMockGeolocationPosition):
        * DumpRenderTree/gtk/TestRunnerGtk.cpp:
        (TestRunner::setMockGeolocationPosition):
        * DumpRenderTree/mac/TestRunnerMac.mm:
        (TestRunner::setMockGeolocationPosition):
        * DumpRenderTree/win/TestRunnerWin.cpp:
        (TestRunner::setMockGeolocationPosition):
        * DumpRenderTree/wx/TestRunnerWx.cpp:
        (TestRunner::setMockGeolocationPosition):
        * WebKitTestRunner/GeolocationProviderMock.cpp:
        (WTR::GeolocationProviderMock::setPosition):
        * WebKitTestRunner/GeolocationProviderMock.h:
        (GeolocationProviderMock):
        * WebKitTestRunner/InjectedBundle/Bindings/CodeGeneratorTestRunner.pm:
        (_platformTypeVariableDeclaration):
        Use a proper constructor for the JSValueRef, it is an opaque type, we are not supposed
        to build the pointer outself.
        This is necessary to support optional JSValueRef properly.

        * WebKitTestRunner/InjectedBundle/Bindings/TestRunner.idl:
        * WebKitTestRunner/InjectedBundle/InjectedBundle.cpp:
        (WTR::InjectedBundle::setMockGeolocationPosition):
        * WebKitTestRunner/InjectedBundle/InjectedBundle.h:
        (InjectedBundle):
        * WebKitTestRunner/InjectedBundle/TestRunner.cpp:
        (WTR::TestRunner::setMockGeolocationPosition):
        * WebKitTestRunner/InjectedBundle/TestRunner.h:
        (TestRunner):
        * WebKitTestRunner/TestController.cpp:
        (WTR::TestController::setMockGeolocationPosition):
        * WebKitTestRunner/TestController.h:
        (TestController):
        * WebKitTestRunner/TestInvocation.cpp:
        (WTR::TestInvocation::didReceiveMessageFromInjectedBundle):

2012-10-04  Raphael Kubo da Costa  <raphael.kubo.da.costa@intel.com>

        Make the Xvfb driver recognize `X' as a valid X server binary.
        https://bugs.webkit.org/show_bug.cgi?id=98434

        Reviewed by Dirk Pranke.

        The X server binary can also be called `X', so account for that
        possibility in the _next_free_display regexp.

        Additionally, make the regular expression require at least one
        space character after the `ps comm' part.

        * Scripts/webkitpy/layout_tests/port/xvfbdriver.py:
        (XvfbDriver._next_free_display):
        * Scripts/webkitpy/layout_tests/port/xvfbdriver_unittest.py:
        (XvfbDriverTest.test_next_free_display):

2012-10-04  Raphael Kubo da Costa  <raphael.kubo.da.costa@intel.com>

        webkitpy: Accept WEBKITOUTPUTDIR in Port._setup_environ_for_server.
        https://bugs.webkit.org/show_bug.cgi?id=98436

        Reviewed by Dirk Pranke.

        The Xvfb driver (ab)uses Port._setup_environ_for_server() to set
        the environment for the server process, and the WEBKITOUTPUTDIR
        environment variable was not being passed through, causing the
        build directory to be wrongfully set to WebKitBuild/ all the time.

        * Scripts/webkitpy/layout_tests/port/base.py:
        (Port.to.setup_environ_for_server):

2012-10-04  Christophe Dumez  <christophe.dumez@intel.com>

        [EFL][WK2] Add setting to allow file access from file:// URLs
        https://bugs.webkit.org/show_bug.cgi?id=98121

        Reviewed by Laszlo Gombos.

        Allow file access from file:// URLs by default in Minibrowser
        to facilitate testing.

        * MiniBrowser/efl/main.c:
        (browserCreate):

2012-10-04  Christophe Dumez  <christophe.dumez@intel.com>

        [EFL] Run unit tests with Xvfb
        https://bugs.webkit.org/show_bug.cgi?id=98389

        Reviewed by Laszlo Gombos.

        Run EFL unit tests with Xvfb, similarly to GTK port.

        * Scripts/run-efl-tests:

2012-10-04  Adrian Perez de Castro  <aperez@igalia.com>

        [GTK] Enable inspector by default in GtkLauncher/MiniBrowser
        https://bugs.webkit.org/show_bug.cgi?id=98333

        Reviewed by Xan Lopez.

        Both MiniBrowser and GtkLauncher are tools for testing, so in
        the end every time we want to test the inspector we have to
        manually enable enable the “developer extras” setting when using
        them. It make sense to have this setting enabled by default.

        * GtkLauncher/main.c:
        (main):
        * MiniBrowser/gtk/main.c:
        (main):

2012-10-04  Harald Alvestrand  <hta@google.com>

        Change RTCPeerConnection GetStats to use Date timestamp format
        https://bugs.webkit.org/show_bug.cgi?id=98263

        Reviewed by Yury Semikhatsky.

        * DumpRenderTree/chromium/MockWebRTCPeerConnectionHandler.cpp:
        (MockWebRTCPeerConnectionHandler::getStats):

2012-10-04  Dirk Pranke  <dpranke@chromium.org>

        [NRWT] --skipped option is ignored when --test-list is used
        https://bugs.webkit.org/show_bug.cgi?id=98260

        Reviewed by Ojan Vafai.

        Adds a --skipped=always flag that will skip any tests listed in
        TestExpectations even if they're listed explicitly on the
        command line.

        This is most useful if you are using --test-list to specify a
        long list of files but you still want to skip some of them
        depending on what's in TestExpectations.

        * Scripts/webkitpy/layout_tests/controllers/layout_test_finder.py:
        (LayoutTestFinder.skip_tests):
        * Scripts/webkitpy/layout_tests/run_webkit_tests.py:
        (parse_args):
        * Scripts/webkitpy/layout_tests/run_webkit_tests_integrationtest.py:
        (MainTest.test_skipped_flag):

2012-10-04  Sheriff Bot  <webkit.review.bot@gmail.com>

        Unreviewed, rolling out r130377.
        http://trac.webkit.org/changeset/130377
        https://bugs.webkit.org/show_bug.cgi?id=98392

        Chromium Win compilation is broken (Requested by yurys on
        #webkit).

        * DumpRenderTree/chromium/MockWebRTCPeerConnectionHandler.cpp:
        (MockWebRTCPeerConnectionHandler::getStats):

2012-10-04  Harald Alvestrand  <hta@google.com>

        Change RTCPeerConnection GetStats to use Date timestamp format
        https://bugs.webkit.org/show_bug.cgi?id=98263

        Reviewed by Adam Barth.

        * DumpRenderTree/chromium/MockWebRTCPeerConnectionHandler.cpp:
        (MockWebRTCPeerConnectionHandler::getStats):

2012-10-04  Raphael Kubo da Costa  <raphael.kubo.da.costa@intel.com>

        Unreviewed, remove unused $legacyWebKitBlobBuilderSupport variable after r130343.

        * Scripts/webkitperl/FeatureList.pm:

2012-10-03  Philip Rogers  <pdr@google.com>

        Force GC between PageLoad tests.
        https://bugs.webkit.org/show_bug.cgi?id=98203

        Reviewed by Ryosuke Niwa.

        Previously, our PageLoad PerfTests had multi-modal distributions,
        typically with a small cluster at 1-2x the median. This turned out
        to be caused by not garbage collecting between tests!

        This patch adds a new file, force-gc.html, and loads this file between
        PageLoad tests to force a GC. I manually verified that this cleans up
        our perf test outliers.

        * Scripts/webkitpy/performance_tests/perftest.py:
        (PageLoadingPerfTest.__init__):
        (PageLoadingPerfTest):
        (PageLoadingPerfTest.run_single):

            This function now loads two pages: one to force a gc and
            then the test to run.

        * Scripts/webkitpy/performance_tests/perftest_unittest.py:

            Modified several existing tests to show that the force-gc file
            is loaded.

        (MockPort):
        (MockPort.__init__):
        (MockPort.perf_tests_dir):
        (TestPageLoadingPerfTest.MockDriver.__init__):
        (TestPageLoadingPerfTest.MockDriver.run_test):
        (TestPageLoadingPerfTest.test_run):
        (TestPageLoadingPerfTest.test_run_with_bad_output):
        (TestReplayPerfTest.ReplayTestPort):
        (TestReplayPerfTest.ReplayTestPort.__init__):
        (TestReplayPerfTest.test_run_single.run_test):
        (TestReplayPerfTest.test_run_single):
        (TestReplayPerfTest.test_run_single_fails_when_output_has_error):
        (TestPerfTestFactory.test_regular_test):
        (TestPerfTestFactory.test_inspector_test):
        (TestPerfTestFactory.test_page_loading_test):

2012-10-03  Christophe Dumez  <christophe.dumez@intel.com>

        [EFL] Enable use of X11 in DumpRenderTree / WebKitTestRunner
        https://bugs.webkit.org/show_bug.cgi?id=98231

        Reviewed by Gyuyoung Kim.

        Enable use of X11 in DumpRenderTree / WebKitTestRunner.
        Call ecore_evas_new() instead of ecore_evas_buffer_new()
        in EFL's DumpRenderTree and WebKitTestRunner.
        It is safe to do this now that we are using XvfbDriver
        for the layout tests.

        * DumpRenderTree/efl/DumpRenderTree.cpp:
        (parseCommandLineOptions):
        (initEcoreEvas):
        * WebKitTestRunner/efl/PlatformWebViewEfl.cpp:
        (WTR::initEcoreEvas):
        * WebKitTestRunner/efl/main.cpp:
        (main):

2012-10-03  Dirk Pranke  <dpranke@chromium.org>

        run-webkit-tests tests on win32 after r127302
        https://bugs.webkit.org/show_bug.cgi?id=98323

        Reviewed by Eric Seidel.

        run-webkit-tests tests on win32 after r127302
        https://bugs.webkit.org/show_bug.cgi?id=98323

        Reviewed by Eric Seidel.

        Looks like when we converted the json-building logic to use scm
        to try and get the svn revision, we missed a win32-ism and
        didn't check to make sure had initialized the scm subsystem.

        This change fixes that and renames _initialize_scm to be a public method.

        * Scripts/webkitpy/common/host.py:
        (Host.initialize_scm):
        * Scripts/webkitpy/common/host_mock.py:
        (MockHost.__init__):
        (MockHost.initialize_scm):
        * Scripts/webkitpy/layout_tests/controllers/manager.py:
        (summarize_results):
        * Scripts/webkitpy/layout_tests/layout_package/json_results_generator.py:
        (JSONResultsGeneratorBase.get_json):
        (JSONResultsGeneratorBase._get_result_char):
        (JSONResultsGeneratorBase._get_svn_revision):
        * Scripts/webkitpy/performance_tests/perftestsrunner.py:
        (PerfTestsRunner.__init__):
        * Scripts/webkitpy/style/checkers/test_expectations.py:
        (TestExpectationsChecker.__init__):
        * Scripts/webkitpy/style/main.py:
        (CheckWebKitStyle.main):
        * Scripts/webkitpy/tool/main.py:
        (WebKitPatch.handle_global_options):
        * Scripts/webkitpy/tool/servers/rebaselineserver.py:
        (get_test_baselines):

2012-10-03  Adrian Perez de Castro  <aperez@igalia.com>

        [GTK] Make inspector directly useable in GtkLauncher/MiniBrowser
        https://bugs.webkit.org/show_bug.cgi?id=98310

        Reviewed by Martin Robinson.

        Make MiniBrowser/GtkLauncher define the path to the inspector
        resources by setting the WEBKIT_INSPECTOR_PATH environment
        variable pointing to the copy of the inspector resources in
        the build directory. If the environment variable is already
        defined, its value is not overwritten. The path is derived
        from the WEBKIT_EXEC_PATH macro defined in the makefiles.

        * GNUmakefile.am:
        * GtkLauncher/main.c:
        (main):
        * MiniBrowser/gtk/main.c:
        (main):

2012-10-03  Benjamin Poulain  <bpoulain@apple.com>

        Fix Geolocation/window-close-crash.html and harden WebKitTestRunner for Geolocation
        https://bugs.webkit.org/show_bug.cgi?id=97608

        Reviewed by Sam Weinig.

        The test fast/dom/Geolocation/window-close-crash.html was crashing because
        handleGeolocationPermissionRequest() was executed on the wrong pointer. Depending on how
        the page was created, the void* clientInfo can either be a PlatformWebView or
        a TestController.

        Using the global TestController fixes the issue.

        * WebKitTestRunner/GeolocationProviderMock.cpp:
        (WTR::GeolocationProviderMock::setPosition):
        (WTR::GeolocationProviderMock::setPositionUnavailableError):
        To be reliable, the test fast/dom/Geolocation/maximum-age.html needs the setting the position
        to clear the error and vice versa.
        This is the same behavior as GeolocationClientMock and MockGeolocationProvider of WebKit1.

        (WTR::GeolocationProviderMock::sendPositionIfNeeded):
        (WTR::GeolocationProviderMock::sendErrorIfNeeded):
        Some tests expect the position/error cant be sent multiple time,
        just keep the position after sending.

        * WebKitTestRunner/TestController.cpp:
        (WTR::decidePolicyForGeolocationPermissionRequest):
        (WTR::TestController::decidePolicyForGeolocationPermissionRequestIfPossible):
        * WebKitTestRunner/TestController.h:
        Let's play as if we did not know what is in GeolocationPermissionRequestManagerProxy like a real
        client would have to do.

2012-10-03  Otto Derek Cheung  <otcheung@rim.com>

        [BlackBerry] Implementing the NetworkInfo API for BB port
        https://bugs.webkit.org/show_bug.cgi?id=98273

        Reviewed by Rob Buis.

        Enabling NetworkInfo API for the BlackBerry port.

        * Scripts/webkitperl/FeatureList.pm:

2012-10-03  Anders Carlsson  <andersca@apple.com>

        Exception thrown when running accessibility/container-node-delete-causes-crash.html test
        https://bugs.webkit.org/show_bug.cgi?id=98291

        Reviewed by Andreas Kling.

        The accessibility/container-node-delete-causes-crash.html test will cause a full accessibility tree
        to be created by trying to look up an element with a non-existent ID. This caused an exception to be thrown
        when trying to access the children of an element that didn't have any children. Fix this by adding
        BEGIN_AX_OBJC_EXCEPTIONS/END_AX_OBJC_EXCEPTIONS around the call to get the children.

        * DumpRenderTree/mac/AccessibilityControllerMac.mm:
        (findAccessibleObjectById):

2012-10-03  Ojan Vafai  <ojan@chromium.org>

        Make partytime work when loading garden-o-matic from trac.webkit.org
        https://bugs.webkit.org/show_bug.cgi?id=98283

        Reviewed by Adam Barth.

        CSP was blocking the reqest for partytime.gif because 'self' wasn't on the img-src directive.
        * BuildSlaveSupport/build.webkit.org-config/public_html/TestFailures/garden-o-matic.html:

2012-10-03  Roger Fong  <roger_fong@apple.com>

        Unreviewed. Adding sys.platform check to skip a failing assert on the Apple Windows platform.
        https://bugs.webkit.org/show_bug.cgi?id=98288

        * Scripts/webkitpy/layout_tests/port/chromium_android_unittest.py:
        (ChromiumAndroidDriverTest.test_command_from_driver_input):

2012-10-03  Ojan Vafai  <ojan@chromium.org>

        Get rid of warning about non-existant platform name when loading garden-o-matic
        https://bugs.webkit.org/show_bug.cgi?id=98282

        Reviewed by Adam Barth.

        If you loaded without a platform query parameter we'd return "null" as the platform name
        instead of null.
        * BuildSlaveSupport/build.webkit.org-config/public_html/TestFailures/scripts/base.js:
        * BuildSlaveSupport/build.webkit.org-config/public_html/TestFailures/scripts/base_unittests.js:

2012-10-03  Balazs Kelemen  <kbalazs@webkit.org>

        [Qt] Enable mock scrollbars
        https://bugs.webkit.org/show_bug.cgi?id=98011

        Reviewed by Csaba Osztrogonác.

        Enable mock scrollbars for the Qt port. This patch will require a huge rebaseline.

        * DumpRenderTree/qt/DumpRenderTreeQt.cpp:
        (WebCore::DumpRenderTree::DumpRenderTree):
        * WebKitTestRunner/TestController.cpp:
        (WTR::TestController::resetStateToConsistentValues):

2012-10-03  Alberto Garcia  <agarcia@igalia.com>

        [GTK] [WK2] Add favicon support to the MiniBrowser
        https://bugs.webkit.org/show_bug.cgi?id=98063

        Reviewed by Carlos Garcia Campos.

        Set the icon in the URI text entry using the favicon property of
        the WebKitWebView.

        * MiniBrowser/gtk/BrowserWindow.c:
        (_BrowserWindow):
        (updateUriEntryIcon):
        (uriEntryTextChanged):
        (faviconChanged):
        (browserWindowFinalize):
        (browser_window_init):
        (browserWindowConstructed):

2012-10-03  Raphael Kubo da Costa  <raphael.kubo.da.costa@intel.com>

        [Qt][DRT] Add support for overriding the "WebKitDisplayImagesKey" preference.
        https://bugs.webkit.org/show_bug.cgi?id=98200

        Reviewed by Csaba Osztrogonác.

        * DumpRenderTree/qt/TestRunnerQt.cpp:
        (TestRunner::overridePreference):

2012-10-03  Zoltan Arvai  <zarvai@inf.u-szeged.hu>

        [Qt][WRT] Fix build error with MSVC on Windows.
        https://bugs.webkit.org/show_bug.cgi?id=97697

        Reviewed by Simon Hausmann.

        WTR build is failing when WebKit directory is located on a longer path.
        This seems to caused by source files that has the same name in
        WTR and DRT directories. The solution is removing referencies 
        from Target.pri to DRT directory and adding an alternate version of
        the required files to WTR. Those files simply include the real ones from DRT.

        * WebKitTestRunner/InjectedBundle/Target.pri:
        * WebKitTestRunner/InjectedBundle/qt/QtInitializeTestFonts.cpp: Added.
        * WebKitTestRunner/InjectedBundle/qt/QtInitializeTestFonts.h: Added.

2012-10-03  Christophe Dumez  <christophe.dumez@intel.com>

        [WK2][WKTR] TestRunner.setAlwaysAcceptCookies() causes flakiness
        https://bugs.webkit.org/show_bug.cgi?id=98238

        Reviewed by Csaba Osztrogonác.

        Reset AlwaysAcceptCookies setting between tests to avoid
        flakiness due to TestRunner.setAlwaysAcceptCookies().

        * WebKitTestRunner/InjectedBundle/InjectedBundle.cpp:
        (WTR::InjectedBundle::beginTesting):

2012-10-03  Harald Alvestrand  <hta@google.com>

        Add data passing to the GetStats interface of RTCPeerConnection
        https://bugs.webkit.org/show_bug.cgi?id=98003

        Reviewed by Adam Barth.

        * DumpRenderTree/chromium/MockWebRTCPeerConnectionHandler.cpp:
        (RTCStatsRequestSucceededTask::RTCStatsRequestSucceededTask):
        (MockWebRTCPeerConnectionHandler::MockWebRTCPeerConnectionHandler):
        (MockWebRTCPeerConnectionHandler::addStream):
        (MockWebRTCPeerConnectionHandler::removeStream):
        (MockWebRTCPeerConnectionHandler::getStats):
        * DumpRenderTree/chromium/MockWebRTCPeerConnectionHandler.h:
        (MockWebRTCPeerConnectionHandler):

== Rolled over to ChangeLog-2012-10-02 ==
